-- Dữ liệu thêm vào CDB để test

CREATE TABLE QLDT_GIAOVIEN
(
    MAGV CHAR(5), 
    HOTEN NVARCHAR2(50),
    NGAYSINH DATE,
    MAPHONG INT,
    MATKHAU VARCHAR2(20),
    LUONG NUMBER,
    
    PRIMARY KEY(MAGV)
);
CREATE TABLE QLDT_PHONGBAN
(
    MAPHONG INT, 
    TENPHONG NVARCHAR2(100),
    TRUONGPHONG CHAR(5),
    CHINHANH VARCHAR(20),
    
    PRIMARY KEY (MAPHONG)
);
CREATE TABLE QLDT_DETAI
(
    MADT CHAR(4),
    TENDT NVARCHAR2(100),
    CAPQL NVARCHAR2(50),
    NGAYDB DATE,
    NGAYKT DATE,
    GVCNDT CHAR(5),
    PHONGQL INT,
    PRIMARY KEY(MADT)
);
CREATE TABLE QLDT_THAMGIA
(
    MADT CHAR(4),
    MAGV CHAR(5),
    VAITRO NVARCHAR2(50),
    THOIGIAN INT,
    PHUCAP DECIMAL(3,1),
    TINHTRANG NVARCHAR2(50),
    PRIMARY KEY(MADT, MAGV)
);
---RELATIONSHIPS
ALTER TABLE QLDT_GIAOVIEN
ADD
    CONSTRAINT FK_GV_PB
    FOREIGN KEY (MAPHONG)
    REFERENCES QLDT_PHONGBAN;
ALTER TABLE QLDT_PHONGBAN
ADD
    CONSTRAINT FK_PB_GV
    FOREIGN KEY (TRUONGPHONG)
    REFERENCES QLDT_GIAOVIEN;
ALTER TABLE QLDT_DETAI
ADD
    CONSTRAINT FK_DT_GV
    FOREIGN KEY (GVCNDT)
    REFERENCES QLDT_GIAOVIEN;
ALTER TABLE QLDT_DETAI
ADD
    CONSTRAINT FK_DT_PB
    FOREIGN KEY (PHONGQL)
    REFERENCES QLDT_PHONGBAN;
ALTER TABLE QLDT_THAMGIA
ADD
    CONSTRAINT FK_TG_DT
    FOREIGN KEY (MADT)
    REFERENCES QLDT_DETAI;
ALTER TABLE QLDT_THAMGIA
ADD
    CONSTRAINT FK_TG_GV
    FOREIGN KEY (MAGV)
    REFERENCES QLDT_GIAOVIEN;

--INSERT DATA
INSERT INTO QLDT_GIAOVIEN
VALUES('GV001',N'NGUYỄN XUÂN TÂM', TO_DATE('2000-3-2','YYYY-MM-DD'),NULL,NULL,3000);
INSERT INTO QLDT_GIAOVIEN
VALUES('GV002',N'TRẦN THÀNH TRUNG', TO_DATE('2001-3-12','YYYY-MM-DD'),NULL,NULL,2000);
INSERT INTO QLDT_GIAOVIEN
VALUES('GV003',N'NGUYỄN MINH HƯƠNG', TO_DATE('2000-9-12','YYYY-MM-DD'),NULL,NULL,500);
INSERT INTO QLDT_GIAOVIEN
VALUES('GV004',N'NGUYỄN GIA BÌNH', TO_DATE('2001-4-20','YYYY-MM-DD'),NULL,NULL,350);
INSERT INTO QLDT_GIAOVIEN
VALUES('GV005',N'VŨ XUÂN MINH', TO_DATE('2000-3-2','YYYY-MM-DD'),NULL,NULL,120);
SELECT * FROM QLDT_GIAOVIEN;

INSERT INTO QLDT_PHONGBAN
VALUES(1,N'QUẢN LÝ', 'GV001','CN1');
INSERT INTO QLDT_PHONGBAN
VALUES(3,N'KỸ THUẬT', 'GV003','CN2');
INSERT INTO QLDT_PHONGBAN
VALUES(4,N'NHÂN SỰ', 'GV002','CN2');
SELECT * FROM QLDT_PHONGBAN;

UPDATE QLDT_GIAOVIEN
SET MAPHONG = 1
WHERE MAGV IN ('GV001','GV004');
UPDATE QLDT_GIAOVIEN
SET MAPHONG = 3
WHERE MAGV IN ('GV003','GV005');
UPDATE QLDT_GIAOVIEN
SET MAPHONG = 4
WHERE MAGV IN ('GV002');

INSERT INTO QLDT_DETAI
VALUES('DT01', N'DỰ ÁN CẢI THIỆN MÔI TRƯỜNG LÀM VIỆC SỬ DỤNG AI',N'THÀNH PHỐ', TO_DATE('2020-1-1','YYYY-MM-DD'),TO_DATE('2025-10-1','YYYY-MM-DD'),'GV001',1);
INSERT INTO QLDT_DETAI
VALUES('DT02', N'DỰ ÁN SỬ DỤNG SENSOR DỰ ĐOÁN CẢM XÚC CỦA NGƯỜI HỌC',N'THÀNH PHỐ', TO_DATE('2021-1-1','YYYY-MM-DD'),TO_DATE('2024-10-1','YYYY-MM-DD'),'GV002',1);
INSERT INTO QLDT_DETAI
VALUES('DT03', N'DỰ ÁN ĐIỂM DANH NGƯỜI HỌC BẰNG CAMERA',N'TRƯỜNG', TO_DATE('2019-1-1','YYYY-MM-DD'),TO_DATE('2022-10-1','YYYY-MM-DD'),'GV003',1);
INSERT INTO QLDT_DETAI
VALUES('DT04', N'DỰ ÁN TƯ VẤN ĐĂNG KÝ HỌC PHẦN CHO NGƯỜI HỌC',N'TRƯỜNG', TO_DATE('2010-1-1','YYYY-MM-DD'),TO_DATE('2015-10-1','YYYY-MM-DD'),'GV001',3);
INSERT INTO QLDT_DETAI
VALUES('DT05', N'DỰ ÁN SỐ HÓA DỮ LIỆU CƯ DÂN',N'NHÀ NƯỚC', TO_DATE('2009-1-1','YYYY-MM-DD'),TO_DATE('2010-10-1','YYYY-MM-DD'),'GV001',4);
INSERT INTO QLDT_DETAI
VALUES('DT06', N'DỰ ÁN CẢI CÁCH THỦ TỤC HÀNH CHÍNH',N'TRƯỜNG', TO_DATE('2020-1-1','YYYY-MM-DD'),TO_DATE('2025-10-1','YYYY-MM-DD'),'GV004',3);
SELECT * FROM QLDT_DETAI;

INSERT INTO QLDT_THAMGIA
VALUES('DT01', 'GV001', N'CHỦ NHIỆM',20, 2.0,N'ĐANG LÀM');
INSERT INTO QLDT_THAMGIA
VALUES('DT01', 'GV004', N'THÀNH VIÊN',10, 1.5,N'ĐÃ HOÀN TÂT');
INSERT INTO QLDT_THAMGIA
VALUES('DT01', 'GV003', N'THÀNH VIÊN',15, 1.7,N'ĐANG LÀM');
INSERT INTO QLDT_THAMGIA
VALUES('DT02', 'GV001', N'THÀNH VIÊN',20, 2.0,N'ĐÃ HOÀN TẤT');
INSERT INTO QLDT_THAMGIA
VALUES('DT02', 'GV002', N'CHỦ NHIỆM',20, 2.0,N'ĐÃ HOÀN TẤT');
INSERT INTO QLDT_THAMGIA
VALUES('DT03', 'GV003', N'CHỦ NHIỆM',20, 2.0,N'ĐÃ HOÀN TẤT');
INSERT INTO QLDT_THAMGIA
VALUES('DT03', 'GV001', N'THÀNH VIÊN',20, 2.0,N'ĐÃ HOÀN TẤT');
INSERT INTO QLDT_THAMGIA
VALUES('DT03', 'GV005', N'THÀNH VIÊN',10, 1.0,N'ĐÃ BỎ');
INSERT INTO QLDT_THAMGIA
VALUES('DT04', 'GV001', N'CHỦ NHIỆM',20, 2.0,N'ĐÃ HOÀN TẤT');
INSERT INTO QLDT_THAMGIA
VALUES('DT05', 'GV001', N'CHỦ NHIỆM',20, 2.0,N'ĐÃ HOÀN TẤT');
INSERT INTO QLDT_THAMGIA
VALUES('DT06', 'GV004', N'CHỦ NHIỆM',20, 2.0,N'ĐANG LÀM');
SELECT * FROM QLDT_THAMGIA;

-- View
CREATE OR REPLACE VIEW GV_MATKHAU AS 
SELECT MAGV, MATKHAU FROM QLDT_GIAOVIEN;

CREATE OR REPLACE VIEW GV_THAMGIADETAI AS 
SELECT MAGV, VAITRO FROM QLDT_THAMGIA;

-- Function
CREATE OR REPLACE FUNCTION FN_TONG_THOIGIAN_THAMGIA(p_magv CHAR)
RETURN NUMBER
IS
    v_tong NUMBER := 0;
BEGIN
    SELECT NVL(SUM(THOIGIAN), 0)
    INTO v_tong
    FROM QLDT_THAMGIA
    WHERE MAGV = p_magv;

    RETURN v_tong;
END;
/

-- Proc
CREATE OR REPLACE PROCEDURE PROC_CAPNHAT_PHUCAP(
    p_madt CHAR,
    p_magv CHAR,
    p_phucap DECIMAL
)
IS
BEGIN
    UPDATE QLDT_THAMGIA
    SET PHUCAP = p_phucap
    WHERE MADT = p_madt AND MAGV = p_magv;

    COMMIT;
END;
/

CREATE OR REPLACE PROCEDURE PROC_DSTHAMGIA_GV(
    p_magv CHAR,
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
    SELECT DT.MADT, DT.TENDT, TG.VAITRO, TG.THOIGIAN, TG.PHUCAP
    FROM QLDT_DETAI DT
    JOIN QLDT_THAMGIA TG ON DT.MADT = TG.MADT
    WHERE TG.MAGV = p_magv;
END;
/
